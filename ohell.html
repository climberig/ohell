<!DOCTYPE html>
<html>
<head>
    <title>Ohell!</title>
    <script src="jquery-1.11.1.js"></script>
    <style>
        #game input, td {
            width: 40px;
            margin-left: 5px;
            text-align: right;
        }
    </style>
</head>
<body>
<script>
    $(document).ready(function () {
        var CARD_LIM = 2;
        var players = ['igor', 'katie', 'emery'], score = [0, 0, 0], roundCount = 0;
        var card = 1, dealer = 0;
        var len = players.length;
        addRow(players, ' ');
        newRound();

        function newRound() {
            roundCount++;
            if (card == 0) {
                return;
            }
            var betsInputs = createInputs(len);
            var betsRow = addRow(betsInputs, card);
            $(betsInputs[0]).focus();
            for (var i = 0; i < len; i++) {
                (function (i) {
                    $(betsInputs[i]).keyup(function (e) {
                        if (i < len - 1) {
                            $(betsInputs[i + 1]).focus();
                        } else if (i == len - 1) {
                            betsRow.remove();
                            var betsValues = values(betsInputs);
                            var betsValuesRow = addRow(betsValues, card);
                            var tricksInputs = createInputs(len);
                            var tricksRow = addRow(tricksInputs, ' ');
                            $(tricksInputs[0]).focus();
                            for (var k = 0; k < len; k++) {
                                (function (k) {
                                    $(tricksInputs[k]).keyup(function (e) {
                                        if (k < len - 1) {
                                            $(tricksInputs[k + 1]).focus();
                                        } else if (k == len - 1) {
                                            betsValuesRow.remove();
                                            tricksRow.remove();
                                            updateScores(betsValues, values(tricksInputs));
                                            addRow(score, card);
                                            nextCard();
                                            newRound();
                                        }
                                    });
                                })(k);
                            }
                        }
                    });
                })(i);
            }
        }

        function updateScores(betsInputs, tricksInputs) {
            for (var i = 0; i < len; i++) {
                var bet = betsInputs[i], trick = tricksInputs[i];
                var diff = Math.abs(bet - trick);
                if (diff == 0) {
                    score[i] += 10 + bet * 2;
                } else {
                    score[i] -= 2 * diff;
                }
            }
        }

        function nextCard() {
            if (roundCount < CARD_LIM) {
                card++;
            } else {
                card--;
            }
        }

        function values(inputs) {
            var values = [];
            for (var i = 0; i < len; i++) {
                values[i] = parseInt($(inputs[i]).val());
            }
            return values;

        }


        function addRow(values, first) {
            var row = $('<tr>');
            if (first) {
                row.append($('<td>').append(first));
            }
            for (var i = 0; i < values.length; i++) {
                row.append($('<td>').append(values[i]));
            }
            $('#game').append(row);
            return row;
        }

        function createInputs(len) {
            var inputs = [];
            for (var i = 0; i < len; i++) {
                inputs[i] = document.createElement('input');
            }
            return inputs;
        }
    });
</script>
<table id="game"></table>
<div id='inputs'></div>
</body>
</html>