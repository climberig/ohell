<!DOCTYPE html>
<html>
<head>
    <title>Ohell!</title>
    <script src="jquery-1.11.1.js"></script>
    <style>
        #game input, td {
            width: 40px;
            margin-left: 5px;
            text-align: right;
        }
    </style>
</head>
<body>
<script>
    $(document).ready(function () {
        var CARD_LIM = 2;
        var players = ['igor', 'katie', 'emery'], score = [0, 0, 0], roundCount = 0;
        var card = 1, dealer = 0;
        var len = players.length;
        addRow(players, ' ');
        newRound();

        function newRound() {
            roundCount++;
            if (card == 0) {
                return;
            }
            var betsInputs = createInputs(len);
            var betsRow = addRow(betsInputs, card);
            $(betsInputs[0]).focus();
            for (var i = 0; i < len; i++) {
                (function (i) {
                    $(betsInputs[i]).keyup(function () {
                        if (hasNumber(this)) {
                            if (i < len - 1) {
                                $(betsInputs[i + 1]).focus();
                                if (i == len - 2) {
                                    var message;
                                    var diff = card - sum(values(betsInputs.slice(0, i + 1)));
                                    if (diff > 0) {
                                        message = 'Can not bid ' + diff;
                                    } else {
                                        message = 'Can bid everything';
                                    }
                                    showMessage(message);
                                }
                            } else if (i == len - 1) {
                                betsRow.remove();
                                var betsValues = values(betsInputs);
                                var betsValuesRow = addRow(betsValues, card);
                                var tricksInputs = createInputs(len);
                                var tricksRow = addRow(tricksInputs, ' ');
                                showMessage('');
                                $(tricksInputs[0]).focus();
                                for (var k = 0; k < len; k++) {
                                    (function (k) {
                                        $(tricksInputs[k]).keyup(function () {
                                            if (hasNumber(this)) {
                                                if (k < len - 1) {
                                                    $(tricksInputs[k + 1]).focus();
                                                } else if (k == len - 1) {
                                                    betsValuesRow.remove();
                                                    tricksRow.remove();
                                                    updateScores(betsValues, values(tricksInputs));
                                                    addRow(score, card);
                                                    nextCard();
                                                    newRound();
                                                }
                                            }
                                        });
                                    })(k);
                                }
                            }
                        }
                    });
                })(i);
            }
        }

        function hasNumber(input) {
            var val = $(input).val();
            return $.isNumeric(val);
        }

        function updateScores(betsInputs, tricksInputs) {
            for (var i = 0; i < len; i++) {
                var bet = betsInputs[i], trick = tricksInputs[i];
                var diff = Math.abs(bet - trick);
                if (diff == 0) {
                    score[i] += 10 + bet * 2;
                } else {
                    score[i] -= 2 * diff;
                }
            }
        }

        function nextCard() {
            if (roundCount < CARD_LIM) {
                card++;
            } else {
                card--;
            }
        }

        function showMessage(m) {
            $('#messages').text(m);
        }

        function sum(values) {
            var sum = 0;
            for (var i = 0; i < values.length; i++) {
                sum += values[i];
            }
            return sum;
        }

        function values(inputs) {
            var vals = [];
            for (var i = 0; i < inputs.length; i++) {
                vals[i] = parseInt($(inputs[i]).val());
            }
            return vals;

        }


        function addRow(values, first) {
            var row = $('<tr>');
            if (first) {
                row.append($('<td>').append(first));
            }
            for (var i = 0; i < values.length; i++) {
                row.append($('<td>').append(values[i]));
            }
            $('#game').append(row);
            return row;
        }

        function createInputs(len) {
            var inputs = [];
            for (var i = 0; i < len; i++) {
                inputs[i] = document.createElement('input');
            }
            return inputs;
        }
    });
</script>
<table id="game"></table>
<div id='messages'></div>
</body>
</html>