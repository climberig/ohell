<!DOCTYPE html>
<html>
<head>
    <title>Ohell!</title>
    <script src="jquery-1.11.1.js"></script>
    <style>

        #editor {
            display: none;
        }

        #board {
            display: none;
        }

        #main tr {
            vertical-align: top;
        }

        #recalculate {
            float: right;
            margin-top: 10px;
        }

        #game {
            float: left;
        }

        #gameEditor input {
            width: 30px;
            margin-left: 5px;
            text-align: right;
        }

        #game input, td {
            width: 40px;
            margin-left: 5px;
            text-align: right;
        }

        #init input {
            width: 200px;
            margin-bottom: 5px;
        }

        #init label {
            display: inline-block;
            width: 100px;
        }

    </style>
</head>
<body>
<script>
    $(document).ready(function () {
        var cardLim, players, len, dealer, score = [], roundCount = 0, card = 1, dealerStr, initialDealer;
        var allBidInputs = [], allTricksInputs = [], allCards = [];

        $('#start').click(function () {
            players = $('#players').val().split(",");
            dealerStr = $('#dealer').val();
            cardLim = parseInt($('#cardLim').val());
            startGame();
        });

        $('#test').click(function () {
            players = ['igor', 'katie', 'emery'];
            dealerStr = 'igor';
            cardLim = 3;
            startGame();
        });

        $('#toggleEditor').click(function () {
            $('#editor').toggle();
        });

        $('#recalculate').click(function () {
            $('#game').find('tr').remove();
            roundCount = 0;
            dealer = initialDealer;
            addGameRow(players, ' ');
            for (var i = 0; i < len; i++)
                score[i] = 0;
            for (var i = 0; i < allBidInputs.length; i++) {
                updateScores(values(allBidInputs[i]), values(allTricksInputs[i]));
                addGameRow(score, allCards[i]);
                roundCount++;
                dealer = increment(dealer);
            }
            newRound();
        });

        function startGame() {
            len = players.length;
            $('#init').remove();
            $('#board').toggle(true);
            $('#gameEditor').css('width', ((len + 1) * 100) + 'px');
            for (var i = 0; i < len; i++) {
                if (dealerStr === players[i])
                    dealer = i;
                score[i] = 0;
            }
            initialDealer = dealer;
            addGameRow(players, ' ');
            editGamePlayersRow();
            newRound();
        }

        function newRound() {
            roundCount++;
            if (card == 0)
                return;
            var playersRow = addGameRow(arrangePlayers(dealer), card);
            var bidInputs = createInputs(len);
            var bidRow = addGameRow(bidInputs, ' ');
            $(bidInputs[0]).focus();
            for (var i = 0; i < len; i++)
                (function (i) {
                    $(bidInputs[i]).keyup(function () {
                        if (hasNumber(this))
                            if (i < len - 1) {
                                $(bidInputs[i + 1]).focus();
                                if (i == len - 2) {
                                    var message;
                                    var diff = card - sum(values(bidInputs.slice(0, i + 1)));
                                    if (diff >= 0)
                                        message = 'Can not bid ' + diff;
                                    else
                                        message = 'Can bid everything';
                                    showMessage(message);
                                }
                            } else if (i == len - 1) {
                                var tricksInputs = createInputs(len);
                                var tricksRow = addGameRow(tricksInputs, ' ');
                                showMessage('');
                                $(tricksInputs[0]).focus();
                                for (var k = 0; k < len; k++)
                                    (function (k) {
                                        $(tricksInputs[k]).keyup(function () {
                                            if (hasNumber(this))
                                                if (k < len - 1)
                                                    $(tricksInputs[k + 1]).focus();
                                                else if (k == len - 1) {
                                                    bidRow.remove();
                                                    tricksRow.remove();
                                                    playersRow.remove();
                                                    var bids = shift(values(bidInputs), dealer), tricks = shift(values(tricksInputs), dealer);
                                                    updateScores(bids, tricks);
                                                    addGameRow(score, card);
                                                    addEditTable(bids, tricks, card);
                                                    allCards.push(card);
                                                    nextCard();
                                                    dealer = increment(dealer);
                                                    newRound();
                                                }
                                        });
                                    })(k);
                            }
                    });
                })(i);
        }

        function addEditTable(bids, tricks, card) {
            var bidInputs = createEditInputs(bids), trickInputs = createEditInputs(tricks);
            addEditRow(bidInputs, trickInputs, card);
            allBidInputs.push(bidInputs);
            allTricksInputs.push(trickInputs);
        }

        function arrangePlayers(dealer) {
            var p = [];
            while (p.length < len) {
                dealer = increment(dealer);
                p.push(players[dealer]);
            }
            return p;
        }

        function hasNumber(input) {
            return $.isNumeric($(input).val());
        }

        function increment(i) {
            return (i + 1) % len;
        }

        function decrement(i) {
            return (len - i - 1) % len;
        }

        function shift(values, position) {
            position = decrement(position);
            var shifted = [];
            for (var i = 0; i < len; i++) {
                shifted[i] = values[position];
                position = increment(position);
            }
            return shifted;
        }

        function updateScores(bids, tricks) {
            for (var i = 0; i < len; i++) {
                var bid = bids[i], trick = tricks[i];
                var diff = Math.abs(bid - trick);
                if (diff == 0)
                    score[i] += 10 + bid * 2;
                else
                    score[i] -= 2 * diff;
            }
        }

        function nextCard() {
            if (roundCount < cardLim)
                card++;
            else
                card--;
        }

        function showMessage(m) {
            $('#messages').text(m);
        }

        function sum(values) {
            var sum = 0;
            for (var i = 0; i < values.length; i++)
                sum += values[i];
            return sum;
        }

        function values(inputs) {
            var vals = [];
            for (var i = 0; i < inputs.length; i++)
                vals[i] = parseInt($(inputs[i]).val());
            return vals;
        }


        function addGameRow(values, first) {
            var row = $('<tr>');
            if (first)
                row.append($('<td>').append(first));
            for (var i = 0; i < values.length; i++)
                row.append($('<td>').append(values[i]));
            $('#game').append(row);
            return row;
        }

        function editGamePlayersRow() {
            var row = $('<tr>');
            row.append($('<td>').append(' '));
            for (var i = 0; i < len; i++)
                row.append($('<td>').append(players[i]));
            $('#gameEditor').append(row);
            return row;
        }

        function addEditRow(bidsInputs, tricksInputs, card) {
            var row = $('<tr>');
            row.append($('<td>').append(card));
            for (var i = 0; i < bidsInputs.length; i++)
                row.append($('<td>').append(bidsInputs[i]).append(tricksInputs[i]));
            $('#gameEditor').append(row);
            return row;
        }

        function createInputs(len) {
            var inputs = [];
            for (var i = 0; i < len; i++)
                inputs[i] = $('<input>');
            return inputs;
        }

        function createEditInputs(values) {
            var inputs = [];
            for (var i = 0; i < values.length; i++) {
                inputs[i] = $('<input>').attr({
                    type: 'text',
                    value: values[i]
                })
            }
            return inputs;
        }
    });
</script>
<div id="init">
    <label for="players">Players:</label><input id="players" type="text"><br/>
    <label for="dealer">Dealer:</label><input id="dealer" type="text"><br/>
    <label for="cardLim">Card Limit:</label><input id="cardLim" type="text"><br/>
    <button id="start">Start Game</button>
    <button id="test">Test Game</button>
</div>
<table id="main">
    <tr>
        <td id="board">
            <table id="game"></table>
            <div id='messages'></div>
            <a id='toggleEditor' href="#">Show/Hide Editor</a>
        </td>
        <td id="editor">
            <table id="gameEditor"></table>
            <button id="recalculate">Recalculate</button>
        </td>
    </tr>
</table>
</body>
</html>